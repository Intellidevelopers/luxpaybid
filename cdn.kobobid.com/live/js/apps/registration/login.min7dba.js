$(function(){$(".show_hide_password img").on("click",showHidePassword);$(".page-fields").on("focus",function(){clearInlineErrors();$("#user-login-button").prop("disabled",false).removeAttr("disabled")});$("#sign-in-with-facebook").on("click",function(e){e.preventDefault();window.open("/social_auth/facebook","social_window_callback","width=400,height=600")});window.onmessage=function(event){$("#facebook_login").val("");$("#google_login").val("");if(event.data.provider==="facebook"&&event.data.type==="social_window_close_successful"){var oldButtonHtml=disableOldButton($("#user-login-button"),$("#user-login-button"),false);clearInlineErrors();$.ajax({type:"POST",url:"/social_auth/signup_verify",dataType:"JSON",data:{provider:"facebook",sign_up_type:"login"},success:function(response){if(_.has(response,"data")&&_.has(response.data,"email")){$(".inform.pv3").html(addInfoMessageToField("Sign into your account once to authorize access with facebook"));$(".inform.pv3").removeClass("dn");$("#facebook_login").val("1");$(".signup-social-buttons").hide();$('input[name="username"]').val(response.data.email);$("#user-login-form").find('input[name="username"]').prop("readonly",true);$("#user-login-button").html('<img src="https://cdn.kobobid.com/live/icon/facebook-login.png" width="16px"  alt="Facebook Login" /> Sign in');enableOldButton(oldButtonHtml,$("#user-login-button"),$("#user-login-form"))}else{window.location.href="/account/notifications"}},error:function(responseError){$(".signup-social-buttons").show();if(responseError.hasOwnProperty("responseJSON")&&responseError.responseJSON.hasOwnProperty("errors")){formatInlineErrorMessages(responseError.responseJSON.errors)}else{window.location.href="/"}enableOldButton(oldButtonHtml,$("#user-login-button"),$("#user-login-form"))}})}};$("#user-login-form").off("submit").on("submit",function(e){e.preventDefault();var $this=$(this);clearInlineErrors();clearAttemptLimiterMsg();var postData={username:$("[name='username']").val(),password:$("[name='password']").val(),facebook_login:$("[name='facebook_login']").val(),google_login:$("[name='google_login']").val(),is_async:true};if($(".agent-login-form-check")[0]){requestCode(postData,$("#user-login-form"),function(){var oldButtonHtml1=disableOldButton($("#user-login-button"),$this,true);ajaxPostLogin(postData,oldButtonHtml1,$this)})}else{var oldButtonHtml=disableOldButton($("#user-login-button"),$this,true);ajaxPostLogin(postData,oldButtonHtml,$this)}})});function generateCaptchaKey(){if(typeof grecaptcha!=="undefined"){grecaptcha.ready(function(){grecaptcha.execute($("#recaptcha_site_key").val(),{action:"submit"}).then(function(token){$("#recaptcha_site_token").val(token)})})}}function ajaxPostLogin(postData,oldButton,this_button){if($("[name='recaptcha_site_token']")[0]){postData.token=$("[name='recaptcha_site_token']").val();postData.honeypot_check=$("[name='why_join_kobobid_from_here']").val()}$.ajax({type:"POST",url:"/login",dataType:"JSON",data:postData,success:function(res){var redirect_url="/welcome";if(typeof res.data!=="undefined"){var user_data=res.data;if(typeof user_data.redirect_url!=="undefined"&&user_data.redirect_url){redirect_url=user_data.redirect_url}}window.location.href=redirect_url},error:function(responseError){if(responseError.hasOwnProperty("responseJSON")&&responseError.responseJSON.hasOwnProperty("errors")){formatInlineErrorMessages(responseError.responseJSON.errors)}else{window.location.href="/"}if($("[name='recaptcha_site_token']")[0]){generateCaptchaKey()}enableOldButton(oldButton,$("#user-login-button"),this_button)}})}function clearAttemptLimiterMsg(){if($("#blockedMsg #msg")[0])$("#blockedMsg #msg").html("").parent().addClass("dn");if($("#attempts")[0])$("#attempts").addClass("dn")}